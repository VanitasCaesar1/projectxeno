---
import Layout from '../../../layout/layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { supabase } from '../../../lib/supabase';
import ReviewForm from '../../../components/ReviewForm.astro';
import ReviewsList from '../../../components/ReviewsList.astro';
import AddToListButton from '../../../components/AddToListButton.astro';

const { type, id } = Astro.params;

if (!type || !id) {
  return Astro.redirect('/404');
}

// Fetch media details from our API
let mediaItem: any = null;
let error: string | null = null;
let isLoading = false;

try {
  const response = await fetch(`${Astro.url.origin}/api/media/${type}/${id}`);
  const data = await response.json();
  
  if (data.success) {
    mediaItem = data.media;
  } else {
    error = data.error?.message || 'Failed to load media details';
    console.error('Media API error:', data.error);
  }
} catch (e) {
  error = 'Failed to load media details';
  console.error('Media fetch error:', e);
}

if (!mediaItem) {
  return Astro.redirect('/404');
}

// Check if user is authenticated
const { data: { user } } = await supabase.auth.getUser();

// Get user's current status for this media if authenticated
let userMediaStatus = null;
if (user) {
  const { data: userMedia } = await supabase
    .from('user_media')
    .select('status')
    .eq('user_id', user.id)
    .eq('media_id', mediaItem.id)
    .single();
  
  userMediaStatus = userMedia?.status || null;
}

// Enhanced formatting functions
function formatRuntime(minutes: number): string {
  if (!minutes) return '';
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours > 0) {
    return `${hours}h ${mins}m`;
  }
  return `${mins}m`;
}

function formatRating(rating: number): string {
  return rating ? rating.toFixed(1) : 'N/A';
}

function formatYearRange(releaseDate: string, status: string): string {
  if (!releaseDate) return '';
  const year = new Date(releaseDate).getFullYear();
  if (status === 'Ended' || status === 'Canceled' || status === 'Finished Airing') {
    return `${year}`;
  }
  return `${year}â€“`;
}

function formatDate(dateString: string): string {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function formatNumber(num: number): string {
  if (!num) return '';
  return num.toLocaleString();
}

function getStatusColor(status: string): string {
  const statusColors = {
    'Released': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
    'In Production': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    'Post Production': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
    'Returning Series': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    'Ended': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
    'Canceled': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
    'Currently Airing': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
    'Finished Airing': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
    'Publishing': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    'Finished': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
  };
  return statusColors[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
}

// Get media type display name
function getMediaTypeDisplay(type: string): string {
  const typeMap = {
    'movie': 'Movie',
    'tv': 'TV Show',
    'book': 'Book',
    'anime': 'Anime',
    'manga': 'Manga'
  };
  return typeMap[type] || type;
}
---

<Layout title={`${mediaItem.title} - ${getMediaTypeDisplay(mediaItem.type)}`}>
  <main role="main" class="min-h-screen flex flex-col">
    <Header />
    <div class="flex-1 bg-gray-50 dark:bg-gray-900">
    <!-- Hero Section with Enhanced Backdrop -->
    <div class="relative">
      {mediaItem.backdrop && (
        <div class="absolute inset-0 h-[500px] overflow-hidden">
          <img 
            src={mediaItem.backdrop} 
            alt={`${mediaItem.title} backdrop`}
            class="w-full h-full object-cover opacity-20 dark:opacity-15"
            loading="eager"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-gray-50 via-gray-50/90 to-gray-50/60 dark:from-gray-900 dark:via-gray-900/90 dark:to-gray-900/60"></div>
        </div>
      )}
      
      <div class="relative z-10 container mx-auto px-4 py-8 lg:py-12">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm">
          <ol class="flex items-center space-x-2 text-gray-500 dark:text-gray-400">
            <li><a href="/" class="hover:text-gray-700 dark:hover:text-gray-200">Home</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href={`/${type === 'tv' ? 'tvshows' : type === 'anime' ? 'anime' : type === 'manga' ? 'anime' : type}s`} class="hover:text-gray-700 dark:hover:text-gray-200 capitalize">{getMediaTypeDisplay(type)}</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-700 dark:text-gray-300 truncate">{mediaItem.title}</li>
          </ol>
        </nav>

        <div class="flex flex-col xl:flex-row gap-8 items-start">
          <!-- Enhanced Poster Section -->
          <div class="flex-shrink-0 w-full xl:w-auto">
            <div class="flex flex-col sm:flex-row xl:flex-col gap-6 items-center xl:items-start">
              {mediaItem.poster ? (
                <img 
                  src={mediaItem.poster} 
                  alt={`${mediaItem.title} poster`}
                  class="w-64 h-96 sm:w-48 sm:h-72 xl:w-64 xl:h-96 object-cover rounded-lg shadow-xl"
                  loading="eager"
                />
              ) : (
                <div class="w-64 h-96 sm:w-48 sm:h-72 xl:w-64 xl:h-96 bg-gray-200 dark:bg-gray-700 rounded-lg shadow-xl flex items-center justify-center">
                  <div class="text-center text-gray-500 dark:text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm">No Image</span>
                  </div>
                </div>
              )}

              <!-- Quick Stats for Mobile/Tablet -->
              <div class="xl:hidden bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm w-full sm:flex-1">
                <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Quick Info</h3>
                <dl class="space-y-2 text-sm">
                  {mediaItem.year && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Year</dt>
                      <dd class="text-gray-900 dark:text-white font-medium">
                        {mediaItem.type === 'tv' ? formatYearRange(mediaItem.releaseDate, mediaItem.status) : mediaItem.year}
                      </dd>
                    </div>
                  )}
                  {mediaItem.rating && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Rating</dt>
                      <dd class="text-gray-900 dark:text-white font-medium flex items-center">
                        <svg class="w-4 h-4 text-yellow-400 fill-current mr-1" viewBox="0 0 20 20">
                          <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                        </svg>
                        {formatRating(mediaItem.rating)}
                      </dd>
                    </div>
                  )}
                  {mediaItem.status && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Status</dt>
                      <dd>
                        <span class={`px-2 py-1 rounded text-xs font-medium ${getStatusColor(mediaItem.status)}`}>
                          {mediaItem.status}
                        </span>
                      </dd>
                    </div>
                  )}
                  {mediaItem.episodes && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Episodes</dt>
                      <dd class="text-gray-900 dark:text-white font-medium">
                        {mediaItem.episodes}
                      </dd>
                    </div>
                  )}
                  {mediaItem.studio && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Studio</dt>
                      <dd class="text-gray-900 dark:text-white font-medium">
                        {mediaItem.studio}
                      </dd>
                    </div>
                  )}
                  {mediaItem.metadata?.season && mediaItem.metadata?.year && (
                    <div class="flex justify-between">
                      <dt class="text-gray-500 dark:text-gray-400">Season</dt>
                      <dd class="text-gray-900 dark:text-white font-medium">
                        {mediaItem.metadata.season} {mediaItem.metadata.year}
                      </dd>
                    </div>
                  )}
                </dl>
              </div>
            </div>
          </div>

          <!-- Enhanced Main Info -->
          <div class="flex-1 space-y-6">
            <div>
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-2 leading-tight">
                    {mediaItem.title}
                  </h1>
                  {mediaItem.originalTitle && mediaItem.originalTitle !== mediaItem.title && (
                    <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300 mb-3">
                      {mediaItem.originalTitle}
                    </p>
                  )}
                </div>
                
                <div class="flex items-center gap-3">
                  <!-- Add to List Button -->
                  {user && (
                    <AddToListButton
                      mediaId={mediaItem.id}
                      mediaType={mediaItem.type}
                      currentStatus={userMediaStatus}
                      externalId={mediaItem.externalId}
                      title={mediaItem.title}
                      description={mediaItem.description}
                      posterUrl={mediaItem.poster}
                      releaseDate={mediaItem.releaseDate}
                      genres={mediaItem.genres}
                      metadata={mediaItem.metadata}
                    />
                  )}
                  
                  <!-- Media Type Badge -->
                  <span class="px-3 py-1 bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 rounded-full text-sm font-medium">
                    {getMediaTypeDisplay(mediaItem.type)}
                  </span>
                </div>
              </div>
              
              <!-- Enhanced Metadata Row -->
              <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-400 mb-4">
                {mediaItem.year && (
                  <span class="flex items-center font-medium bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                    {mediaItem.type === 'tv' ? formatYearRange(mediaItem.releaseDate, mediaItem.status) : mediaItem.year}
                  </span>
                )}
                {mediaItem.runtime && (
                  <span class="flex items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                    </svg>
                    {formatRuntime(mediaItem.runtime)}
                  </span>
                )}
                {mediaItem.episodes && (
                  <span class="flex items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                    </svg>
                    {mediaItem.episodes} episodes
                  </span>
                )}
                {mediaItem.studio && (
                  <span class="flex items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4H7V5zm8 8v2h1v-2h-1zm-2-2H4v4h9v-4z" clip-rule="evenodd" />
                    </svg>
                    {mediaItem.studio}
                  </span>
                )}
                {mediaItem.metadata?.season && mediaItem.metadata?.year && (
                  <span class="flex items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                    </svg>
                    {mediaItem.metadata.season} {mediaItem.metadata.year}
                  </span>
                )}
                {mediaItem.pages && (
                  <span class="flex items-center bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    {mediaItem.pages} pages
                  </span>
                )}
                {mediaItem.status && (
                  <span class={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(mediaItem.status)}`}>
                    {mediaItem.status}
                  </span>
                )}
              </div>
            </div>

            <!-- Enhanced Rating Section -->
            {mediaItem.rating && (
              <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="flex items-center">
                      <svg class="w-6 h-6 text-yellow-400 fill-current" viewBox="0 0 20 20">
                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                      </svg>
                      <span class="ml-2 text-2xl font-bold text-gray-900 dark:text-white">
                        {formatRating(mediaItem.rating)}
                      </span>
                      <span class="ml-1 text-gray-500 dark:text-gray-400">/10</span>
                    </div>
                    {mediaItem.voteCount && (
                      <div class="text-sm text-gray-600 dark:text-gray-400">
                        <div>{formatNumber(mediaItem.voteCount)} votes</div>
                        {mediaItem.metadata?.rank && (
                          <div>Ranked #{formatNumber(mediaItem.metadata.rank)}</div>
                        )}
                      </div>
                    )}
                  </div>
                  
                  <!-- Rating visualization -->
                  <div class="flex items-center space-x-1">
                    {Array.from({ length: 5 }, (_, i) => (
                      <svg 
                        class={`w-5 h-5 ${i < Math.floor(mediaItem.rating / 2) ? 'text-yellow-400 fill-current' : 'text-gray-300 dark:text-gray-600'}`} 
                        viewBox="0 0 20 20"
                      >
                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                      </svg>
                    ))}
                  </div>
                </div>
              </div>
            )}

            <!-- Enhanced Genres -->
            {mediaItem.genres.length > 0 && (
              <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Genres</h3>
                <div class="flex flex-wrap gap-2">
                  {mediaItem.genres.map(genre => (
                    <span class="px-4 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 text-blue-700 dark:text-blue-300 rounded-full text-sm font-medium border border-blue-200 dark:border-blue-800 hover:from-blue-100 hover:to-indigo-100 dark:hover:from-blue-900/30 dark:hover:to-indigo-900/30 transition-colors">
                      {genre}
                    </span>
                  ))}
                </div>
              </div>
            )}

            <!-- Enhanced Description -->
            {mediaItem.description && (
              <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Synopsis</h3>
                <div class="prose dark:prose-invert max-w-none">
                  <p class="text-gray-700 dark:text-gray-300 leading-relaxed text-base">
                    {mediaItem.description}
                  </p>
                </div>
              </div>
            )}

            <!-- Enhanced Action Buttons -->
            {user && (
              <div class="flex flex-wrap gap-3 pt-2">
                <button class="flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all duration-200 shadow-sm hover:shadow-md">
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                  </svg>
                  Add to List
                </button>
                <button 
                  id="rateReviewBtn"
                  class="flex items-center px-6 py-3 bg-white hover:bg-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium transition-all duration-200 shadow-sm hover:shadow-md border border-gray-200 dark:border-gray-600"
                >
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  Rate & Review
                </button>
                {mediaItem.metadata?.trailerKey && (
                  <button class="flex items-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-all duration-200 shadow-sm hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Watch Trailer
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Detailed Information -->
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Cast & Crew (for movies/TV/anime) -->
          {(mediaItem.cast?.length > 0 || mediaItem.director || mediaItem.metadata?.castWithDetails?.length > 0) && (
            <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Cast & Crew</h2>
              
              {mediaItem.director && (
                <div class="mb-6">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4H7V5zm8 8v2h1v-2h-1zm-2-2H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    {mediaItem.type === 'tv' ? 'Creator(s)' : 'Director'}
                  </h3>
                  <p class="text-gray-700 dark:text-gray-300 text-lg">{mediaItem.director}</p>
                </div>
              )}
              
              {(mediaItem.cast?.length > 0 || mediaItem.metadata?.castWithDetails?.length > 0) && (
                <div>
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    Cast
                  </h3>
                  
                  {mediaItem.metadata?.castWithDetails?.length > 0 ? (
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      {mediaItem.metadata.castWithDetails.slice(0, 12).map(actor => (
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                          {actor.profilePath ? (
                            <img 
                              src={`https://image.tmdb.org/t/p/w92${actor.profilePath}`}
                              alt={actor.name}
                              class="w-12 h-12 rounded-full object-cover"
                              loading="lazy"
                            />
                          ) : (
                            <div class="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center">
                              <svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                              </svg>
                            </div>
                          )}
                          <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 dark:text-white truncate">{actor.name}</p>
                            {actor.character && (
                              <p class="text-sm text-gray-500 dark:text-gray-400 truncate">as {actor.character}</p>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div class="flex flex-wrap gap-2">
                      {mediaItem.cast.slice(0, 15).map(actor => (
                        <span class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium">
                          {actor}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              )}

              <!-- Characters (for anime/manga) -->
              {mediaItem.metadata?.characters?.length > 0 && (
                <div class="mt-6">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    Main Characters
                  </h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {mediaItem.metadata.characters.slice(0, 8).map(character => (
                      <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                          <p class="font-medium text-gray-900 dark:text-white">{character.name}</p>
                          <p class="text-sm text-gray-500 dark:text-gray-400">{character.role}</p>
                        </div>
                        {character.voiceActors?.length > 0 && (
                          <div class="text-right">
                            <p class="text-xs text-gray-500 dark:text-gray-400">Voice Actor</p>
                            <p class="text-sm text-gray-700 dark:text-gray-300">{character.voiceActors[0]}</p>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </section>
          )}

          <!-- Author/Studio Info -->
          {(mediaItem.author || mediaItem.studio) && (
            <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
                {mediaItem.type === 'book' ? 'Author' : mediaItem.type === 'manga' ? 'Author' : 'Studio'}
              </h2>
              <div class="text-gray-700 dark:text-gray-300">
                {mediaItem.author && (
                  <div class="mb-4">
                    <p class="text-lg font-medium">{mediaItem.author}</p>
                    {mediaItem.metadata?.authorDetails?.length > 0 && (
                      <div class="mt-2 space-y-2">
                        {mediaItem.metadata.authorDetails.map(author => (
                          <div class="text-sm">
                            {author.bio && <p class="text-gray-600 dark:text-gray-400">{author.bio}</p>}
                            {(author.birthDate || author.deathDate) && (
                              <p class="text-gray-500 dark:text-gray-500">
                                {author.birthDate} {author.deathDate && `- ${author.deathDate}`}
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
                {mediaItem.studio && (
                  <p class="text-lg font-medium">{mediaItem.studio}</p>
                )}
              </div>
            </section>
          )}

          <!-- Production Info -->
          {(mediaItem.metadata?.productionCompanies?.length > 0 || mediaItem.metadata?.networks?.length > 0 || mediaItem.metadata?.studios?.length > 0) && (
            <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Production</h2>
              
              {mediaItem.metadata?.productionCompanies?.length > 0 && (
                <div class="mb-4">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Production Companies</h3>
                  <div class="flex flex-wrap gap-2">
                    {mediaItem.metadata.productionCompanies.map(company => (
                      <span class="px-3 py-1 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-full text-sm">
                        {company}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {mediaItem.metadata?.networks?.length > 0 && (
                <div class="mb-4">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Networks</h3>
                  <div class="flex flex-wrap gap-2">
                    {mediaItem.metadata.networks.map(network => (
                      <span class="px-3 py-1 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-full text-sm">
                        {network}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {mediaItem.metadata?.studios?.length > 0 && (
                <div>
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Studios</h3>
                  <div class="flex flex-wrap gap-2">
                    {mediaItem.metadata.studios.map(studio => (
                      <span class="px-3 py-1 bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-300 rounded-full text-sm">
                        {studio}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </section>
          )}

          <!-- Seasons (for TV shows) -->
          {mediaItem.metadata?.seasons?.length > 0 && (
            <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Seasons</h2>
              <div class="space-y-4">
                {mediaItem.metadata.seasons.filter(season => season.seasonNumber > 0).map(season => (
                  <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center space-x-4">
                      {season.posterPath && (
                        <img 
                          src={`https://image.tmdb.org/t/p/w92${season.posterPath}`}
                          alt={season.name}
                          class="w-16 h-24 object-cover rounded"
                          loading="lazy"
                        />
                      )}
                      <div>
                        <h3 class="font-semibold text-gray-900 dark:text-white">{season.name}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                          {season.episodeCount} episodes
                        </p>
                        {season.airDate && (
                          <p class="text-sm text-gray-500 dark:text-gray-500">
                            {formatDate(season.airDate)}
                          </p>
                        )}
                      </div>
                    </div>
                    <div class="text-right">
                      <span class="text-lg font-bold text-gray-900 dark:text-white">
                        Season {season.seasonNumber}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>

        <!-- Enhanced Sidebar -->
        <div class="space-y-6">
          <!-- Quick Stats (Desktop) -->
          <section class="hidden xl:block bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
            <dl class="space-y-4">
              {mediaItem.rating && (
                <div class="flex justify-between items-center">
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Rating</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-bold flex items-center">
                    <svg class="w-4 h-4 text-yellow-400 fill-current mr-1" viewBox="0 0 20 20">
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                    </svg>
                    {formatRating(mediaItem.rating)}/10
                  </dd>
                </div>
              )}
              
              {mediaItem.metadata?.popularity && (
                <div class="flex justify-between items-center">
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Popularity</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    #{formatNumber(Math.round(mediaItem.metadata.popularity))}
                  </dd>
                </div>
              )}

              {mediaItem.metadata?.members && (
                <div class="flex justify-between items-center">
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Members</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    {formatNumber(mediaItem.metadata.members)}
                  </dd>
                </div>
              )}

              {mediaItem.metadata?.favorites && (
                <div class="flex justify-between items-center">
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Favorites</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    {formatNumber(mediaItem.metadata.favorites)}
                  </dd>
                </div>
              )}
            </dl>
          </section>

          <!-- Technical Details -->
          <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Details</h3>
            <dl class="space-y-3">
              {mediaItem.releaseDate && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Release Date</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    {formatDate(mediaItem.releaseDate)}
                  </dd>
                </div>
              )}
              
              {mediaItem.language && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Original Language</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">{mediaItem.language.toUpperCase()}</dd>
                </div>
              )}

              {mediaItem.metadata?.spokenLanguages?.length > 0 && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Spoken Languages</dt>
                  <dd class="text-sm text-gray-900 dark:text-white">
                    {mediaItem.metadata.spokenLanguages.join(', ')}
                  </dd>
                </div>
              )}

              {mediaItem.metadata?.productionCountries?.length > 0 && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Countries</dt>
                  <dd class="text-sm text-gray-900 dark:text-white">
                    {mediaItem.metadata.productionCountries.join(', ')}
                  </dd>
                </div>
              )}
              
              {mediaItem.publisher && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Publisher</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">{mediaItem.publisher}</dd>
                </div>
              )}
              
              {mediaItem.isbn && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">ISBN</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-mono">{mediaItem.isbn}</dd>
                </div>
              )}

              {mediaItem.metadata?.budget && mediaItem.metadata.budget > 0 && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Budget</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    ${formatNumber(mediaItem.metadata.budget)}
                  </dd>
                </div>
              )}

              {mediaItem.metadata?.revenue && mediaItem.metadata.revenue > 0 && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Revenue</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">
                    ${formatNumber(mediaItem.metadata.revenue)}
                  </dd>
                </div>
              )}

              {mediaItem.metadata?.chapters && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Chapters</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">{mediaItem.metadata.chapters}</dd>
                </div>
              )}

              {mediaItem.metadata?.volumes && (
                <div>
                  <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Volumes</dt>
                  <dd class="text-sm text-gray-900 dark:text-white font-medium">{mediaItem.metadata.volumes}</dd>
                </div>
              )}
            </dl>
          </section>

          <!-- External Links -->
          <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">External Links</h3>
            <div class="space-y-3">
              {mediaItem.source === 'tmdb' && (
                <a 
                  href={`https://www.themoviedb.org/${mediaItem.type}/${mediaItem.externalId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center p-3 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                  </svg>
                  View on TMDB
                </a>
              )}
              
              {mediaItem.source === 'openlibrary' && (
                <a 
                  href={`https://openlibrary.org${mediaItem.externalId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center p-3 bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                  </svg>
                  View on Open Library
                </a>
              )}
              
              {mediaItem.source === 'jikan' && (
                <a 
                  href={`https://myanimelist.net/${mediaItem.type}/${mediaItem.externalId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center p-3 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:hover:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                  </svg>
                  View on MyAnimeList
                </a>
              )}

              {mediaItem.metadata?.homepage && (
                <a 
                  href={mediaItem.metadata.homepage}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center p-3 bg-gray-50 hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.083 9h1.946c.089-1.546.383-2.97.837-4.118A6.004 6.004 0 004.083 9zM10 2a8 8 0 100 16 8 8 0 000-16zm0 2c-.076 0-.232.032-.465.262-.238.234-.497.623-.737 1.182-.389.907-.673 2.142-.766 3.556h3.936c-.093-1.414-.377-2.649-.766-3.556-.24-.56-.5-.948-.737-1.182C10.232 4.032 10.076 4 10 4zm3.971 5c-.089-1.546-.383-2.97-.837-4.118A6.004 6.004 0 0115.917 9h-1.946zm-2.003 2H8.032c.093 1.414.377 2.649.766 3.556.24.56.5.948.737 1.182.233.23.389.262.465.262.076 0 .232-.032.465-.262.238-.234.498-.623.737-1.182.389-.907.673-2.142.766-3.556zm1.166 4.118c.454-1.147.748-2.572.837-4.118h1.946a6.004 6.004 0 01-2.783 4.118zm-6.268 0C6.412 13.97 6.118 12.546 6.03 11H4.083a6.004 6.004 0 002.783 4.118z" clip-rule="evenodd" />
                  </svg>
                  Official Website
                </a>
              )}

              {mediaItem.metadata?.imdbId && (
                <a 
                  href={`https://www.imdb.com/title/${mediaItem.metadata.imdbId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center p-3 bg-yellow-50 hover:bg-yellow-100 dark:bg-yellow-900/20 dark:hover:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                  </svg>
                  View on IMDb
                </a>
              )}
            </div>
          </section>

          <!-- Additional Metadata -->
          {(mediaItem.metadata?.keywords?.length > 0 || mediaItem.metadata?.themes?.length > 0) && (
            <section class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
              <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Tags</h3>
              
              {mediaItem.metadata?.keywords?.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Keywords</h4>
                  <div class="flex flex-wrap gap-1">
                    {mediaItem.metadata.keywords.slice(0, 10).map(keyword => (
                      <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded text-xs">
                        {keyword}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {mediaItem.metadata?.themes?.length > 0 && (
                <div>
                  <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Themes</h4>
                  <div class="flex flex-wrap gap-1">
                    {mediaItem.metadata.themes.map(theme => (
                      <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 rounded text-xs">
                        {theme}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </section>
          )}
        </div>
      </div>
      
      <!-- Reviews Section -->
      <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
          <!-- Review Form (for authenticated users who have completed the media) -->
          {user && (
            <div id="reviewFormSection" class="mb-8">
              <ReviewForm 
                mediaId={mediaItem.id}
                mediaType={mediaItem.type}
                mediaTitle={mediaItem.title}
              />
            </div>
          )}
          
          <!-- Reviews List -->
          <ReviewsList 
            mediaId={mediaItem.id}
            showMedia={false}
            showActions={true}
            currentUserId={user?.id}
            limit={10}
            sortBy="created_at"
            sortOrder="desc"
          />
        </div>
      </div>
    </div>
    <Footer />
  </main>
</Layout>

<style>
  /* Enhanced responsive behavior */
  @media (max-width: 1024px) {
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
  
  /* Smooth transitions for all interactive elements */
  button, a {
    transition: all 0.2s ease-in-out;
  }
  
  /* Enhanced backdrop overlay for better readability */
  .backdrop-overlay {
    background: linear-gradient(
      to bottom,
      rgba(249, 250, 251, 0.05) 0%,
      rgba(249, 250, 251, 0.9) 60%,
      rgba(249, 250, 251, 1) 100%
    );
  }
  
  @media (prefers-color-scheme: dark) {
    .backdrop-overlay {
      background: linear-gradient(
        to bottom,
        rgba(17, 24, 39, 0.05) 0%,
        rgba(17, 24, 39, 0.9) 60%,
        rgba(17, 24, 39, 1) 100%
      );
    }
  }

  /* Loading animation for images */
  img {
    transition: opacity 0.3s ease-in-out;
  }

  /* Hover effects for cards */
  .hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* Custom scrollbar for webkit browsers */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.5);
  }

  /* Responsive text scaling */
  @media (max-width: 640px) {
    .responsive-text-4xl {
      font-size: 2rem;
      line-height: 2.5rem;
    }
  }

  /* Focus styles for accessibility */
  button:focus, a:focus {
    outline: 2px solid #3B82F6;
    outline-offset: 2px;
  }

  /* Print styles */
  @media print {
    .no-print {
      display: none !important;
    }
    
    .print-break-inside-avoid {
      break-inside: avoid;
    }
  }
</style>

<script>
  // Enhanced image loading with error handling
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img[loading="lazy"], img[loading="eager"]');
    
    images.forEach(img => {
      img.addEventListener('error', function() {
        // Replace broken images with placeholder
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDIwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMDAgMTUwTDEyNSAxMjVIMTc1VjI1MEg3NVYxMjVIMTAwVjE1MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+';
        this.alt = 'Image not available';
      });
    });

    // Trailer button functionality
    const trailerButton = document.querySelector('[data-trailer-key]');
    if (trailerButton) {
      trailerButton.addEventListener('click', function() {
        const trailerKey = this.dataset.trailerKey;
        if (trailerKey) {
          window.open(`https://www.youtube.com/watch?v=${trailerKey}`, '_blank');
        }
      });
    }

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Rate & Review button functionality
    const rateReviewBtn = document.getElementById('rateReviewBtn');
    if (rateReviewBtn) {
      rateReviewBtn.addEventListener('click', function() {
        const reviewSection = document.getElementById('reviewFormSection');
        if (reviewSection) {
          reviewSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
          // Focus on the review form after scrolling
          setTimeout(() => {
            const reviewContent = document.getElementById('reviewContent');
            if (reviewContent) {
              reviewContent.focus();
            }
          }, 500);
        }
      });
    }
  });
</script>